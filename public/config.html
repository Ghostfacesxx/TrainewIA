<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainew IA</title>
    <link rel="icon" href="img/favicon.png" type="image/png">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/inicio.css">
    <link rel="stylesheet" href="../css/dark-theme.css">
    <link rel="stylesheet" href="../css/accessibility.css">
    <script src="../js/theme-manager.js"></script>
    <script src="../js/font-manager.js"></script>

    <script>
        // Verificar se o usu√°rio est√° logado
        AuthManager.requireAuth();
        
        // Inicializa os modais ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Modal Menu
            document.querySelector('.header-item.menu').addEventListener('click', function() {
                document.getElementById('menu-modal-bg').style.display = 'block';
            });
            document.getElementById('menu-modal-bg').addEventListener('click', function(e) {
                if (e.target.id === 'menu-modal-bg') {
                    this.style.display = 'none';
                }
            });

            // Modal Perfil
            document.getElementById('perfil-btn').addEventListener('click', showPerfilModal);
            document.getElementById('perfil-modal-bg').addEventListener('click', hidePerfilModal);
            
            // Foto em tela cheia
            document.getElementById('perfil-img').addEventListener('click', function() {
                const src = this.src;
                const fullscreenBg = document.getElementById('foto-fullscreen-bg');
                const fullscreenImg = document.getElementById('foto-fullscreen-img');
                fullscreenImg.src = src;
                fullscreenBg.style.display = 'flex';
            });
            
            document.getElementById('foto-fullscreen-bg').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    document.getElementById('foto-fullscreen-img').src = '';
                }
            });
        });
    </script>
</head>

<body>
    <header class="header">
        <img onclick="window.location.href='inicio.html'" src="img/logo.png" alt="Logo Trainew IA" class="logo">
        <nav class="header-nav">
            <div class="header-item menu">
                <span class="menu-icon">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </span>
                <span class="item-label">Menu</span>
            </div>
            <div onclick="window.location.href='chat.html'" class="header-item chat">
                <img src="img/icon-ia.png" class="chat-icon">
                <span class="item-label">Chat IA</span>
            </div>
            <div class="header-item perfil" id="perfil-btn">
                <img src="img/icon.png" class="perfil-icon" id="header-perfil-icon">
                <span class="item-label">Perfil</span>
            </div>
        </nav>
    </header>

    <!-- √Årea principal de configura√ß√µes -->
    <div class="container" style="max-width: 600px; margin: 0 auto; padding: 0 20px;">
        <h1 style="text-align: center; margin: 15px 0; font-size: 24px;">Configura√ß√µes</h1>
        
        <!-- Switch do tema -->
        <div class="theme-switch" style="margin-top: 20px;">
            <span class="theme-switch-text">Modo Escuro</span>
            <label class="switch">
                <input type="checkbox" id="theme-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <!-- Controle de Acessibilidade - Tamanho da Fonte -->
        <div class="accessibility-section" style="margin-top: 25px; padding: 18px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color);">
            <h2 style="color: var(--text-color); font-size: 17px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">‚ôø</span>
                Acessibilidade
            </h2>
            
            <div class="font-size-control" style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span class="font-control-label" style="color: var(--text-color); font-weight: 600; font-size: 15px;">
                        Tamanho da Fonte
                    </span>
                    <span id="font-size-indicator" style="color: var(--text-secondary); font-size: 13px; font-weight: 600;">
                        Normal
                    </span>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap;">
                    <button id="font-decrease" class="font-btn" style="width: 42px; height: 42px; border-radius: 10px; border: 2px solid #7A1919; background: white; color: #7A1919; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;">
                        A-
                    </button>
                    
                    <div style="flex: 1; min-width: 180px; max-width: 350px;">
                        <input type="range" id="font-size-slider" min="0" max="4" value="2" step="1" 
                               style="width: 100%; height: 6px; border-radius: 5px; background: linear-gradient(to right, #7A1919 0%, #7A1919 50%, #ddd 50%, #ddd 100%); outline: none; appearance: none; -webkit-appearance: none; cursor: pointer;">
                    </div>
                    
                    <button id="font-increase" class="font-btn" style="width: 42px; height: 42px; border-radius: 10px; border: 2px solid #7A1919; background: #7A1919; color: white; font-size: 20px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;">
                        A+
                    </button>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 0 8px; color: var(--text-secondary); font-size: 11px;">
                    <span>Pequeno</span>
                    <span>Normal</span>
                    <span>Grande</span>
                </div>
                
                <p style="color: var(--text-secondary); font-size: 12px; line-height: 1.5; margin-top: 8px; text-align: center;">
                    Ajuste o tamanho da fonte para melhorar a legibilidade em todas as p√°ginas do aplicativo.
                </p>
            </div>
        </div>

        <!-- Zona de Perigo - Excluir Conta -->
        <div class="danger-zone-section" style="margin-top: 25px; margin-bottom: 25px; padding: 18px; background: var(--card-bg); border-radius: 12px; border: 2px solid #c62828;">
            <h2 style="color: #ff5252; font-size: 17px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">‚ö†Ô∏è</span>
                Excluir Minha Conta
            </h2>
            
            <div>
                <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin-bottom: 15px;">
                    A exclus√£o da conta √© permanente e irrevers√≠vel. Todos os seus dados, incluindo hist√≥rico de conversas, treinos, dietas e an√°lises de alimenta√ß√£o ser√£o perdidos para sempre.
                </p>
                <button id="delete-account-btn" style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #c62828; background: transparent; color: #c62828; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s;">
                    üóëÔ∏è Excluir Minha Conta
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o de Conta -->
    <div class="delete-account-modal-overlay" id="delete-account-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 10001; align-items: center; justify-content: center;">
        <div class="delete-account-modal" style="background: white; border-radius: 14px; padding: 25px 20px; max-width: 420px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); animation: modalSlideIn 0.3s ease-out;">
            <div style="font-size: 42px; text-align: center; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <h3 style="font-size: 20px; font-weight: 700; text-align: center; margin-bottom: 12px; color: #c62828;">
                Excluir Conta Permanentemente?
            </h3>
            <p style="font-size: 14px; text-align: center; margin-bottom: 15px; color: #666; line-height: 1.5;">
                Esta a√ß√£o <strong>n√£o pode ser desfeita</strong>. Todos os seus dados ser√£o perdidos permanentemente:
            </p>
            <ul style="font-size: 13px; color: #666; margin-bottom: 18px; line-height: 1.6; padding-left: 20px;">
                <li>Hist√≥rico de conversas com a IA</li>
                <li>Planos de treino personalizados</li>
                <li>Planos de dieta personalizados</li>
                <li>Hist√≥rico de an√°lises de alimenta√ß√£o</li>
                <li>Todas as configura√ß√µes e prefer√™ncias</li>
            </ul>
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                <p style="font-size: 12px; color: #856404; margin: 0; text-align: center;">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Digite sua senha para confirmar
                </p>
            </div>
            <input type="password" id="delete-account-password" placeholder="Digite sua senha" style="width: 100%; padding: 11px 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 18px; box-sizing: border-box;">
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="closeDeleteAccountModal()" style="padding: 11px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #e0e0e0; color: #333;">
                    Cancelar
                </button>
                <button onclick="confirmDeleteAccount()" style="padding: 11px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); color: white;">
                    Sim, Excluir Permanentemente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Perfil -->
    <div class="perfil-modal-bg" id="perfil-modal-bg" style="display:none;">
        <div class="perfil-modal" id="perfil-modal">
            <div class="perfil-modal-header">Conta</div>
            <div class="perfil-modal-user">
                <span class="perfil-modal-user-icon" id="perfil-user-icon">
                    <img src="img/icon.png" alt="Perfil" id="perfil-img" style="cursor:pointer;">
                </span>
                <div class="perfil-modal-user-info">
                    <span class="perfil-modal-user-nome" id="perfil-nome"></span>
                    <span class="perfil-modal-user-email" id="perfil-email"></span>
                </div>
            </div>
            <hr class="perfil-modal-divider">
            <div class="perfil-modal-list">
                <div class="perfil-modal-item" id="alterar-foto-btn">Alterar foto de perfil
                    <input type="file" id="foto-input" accept="image/*" style="display:none;">
                </div>
                <div class="perfil-modal-item" id="alterar-nome-btn">Alterar nome</div>
                <div class="perfil-modal-item" onclick="window.location.href='config.html'">Configura√ß√µes</div>
                <div class="perfil-modal-item" onclick="window.location.href='ajuda.html'">Ajuda</div>
                <div class="perfil-modal-item" id="sair-btn" style="color:#c00;font-weight:600;">Sair</div>
            </div>
        </div>
    </div>

    <!-- Overlay para foto em tela cheia -->
    <div id="foto-fullscreen-bg"
        style="display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;">
        <img id="foto-fullscreen-img" src="" alt="Foto perfil"
            style="max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 4px 32px #000;">
    </div>

    <!-- Modal Menu Lateral -->
    <div class="menu-modal-bg" id="menu-modal-bg" style="display:none;">
        <div class="menu-modal" id="menu-modal">
            <div class="menu-modal-header">
                <span>Menu</span>
            </div>
            <hr class="menu-modal-divider">
            <div class="menu-modal-list">
                <div onclick="window.location.href='chat.html'" class="menu-modal-item">Chat IA</div>
                <div onclick="window.location.href='treino.html'" class="menu-modal-item">Treinos</div>
                <div onclick="window.location.href='dieta.html'" class="menu-modal-item">Dieta</div>
                <div onclick="window.location.href='alimentacao.html'" class="menu-modal-item">Alimenta√ß√£o</div>
                <div onclick="window.location.href='playlists.html'" class="menu-modal-item">Playlists</div>
                <div onclick="window.location.href='avaliacao.html'" class="menu-modal-item">Execu√ß√£o</div>
                <div onclick="window.location.href='sobre.html'" class="menu-modal-item">Sobre n√≥s</div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <hr class="footer-line">
    </footer>

    <script>
        // Inicializa o gerenciador de tema
        ThemeManager.init();

        // Configura o switch do tema
        const themeToggle = document.getElementById('theme-toggle');
        
        // Define o estado inicial do switch baseado no tema atual
        themeToggle.checked = ThemeManager.getCurrentTheme() === 'dark';
        
        // Adiciona o evento de mudan√ßa do switch
        themeToggle.addEventListener('change', function() {
            const newTheme = ThemeManager.toggleTheme();
            this.checked = newTheme === 'dark';
        });

        // Utilit√°rio para atualizar localStorage e sess√£o
        function atualizarUsuarioLogado(novosDados) {
            let usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
            usuario = { ...usuario, ...novosDados };
            localStorage.setItem('usuarioLogado', JSON.stringify(usuario));
            // Atualiza tamb√©m na lista de usu√°rios
            let usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            usuarios = usuarios.map(u => u.email === usuario.email ? { ...u, ...novosDados } : u);
            localStorage.setItem('usuarios', JSON.stringify(usuarios));
        }

        // Atualiza a foto do header com a foto do usu√°rio logado
        function atualizarFotoHeader() {
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
            const headerIcon = document.getElementById('header-perfil-icon');
            if (usuario.fotoPerfil) {
                headerIcon.src = usuario.fotoPerfil;
            } else {
                headerIcon.src = "img/icon.png";
            }
        }

        // Chame ao abrir a p√°gina
        atualizarFotoHeader();

        // Modal Perfil
        function showPerfilModal() {
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
            document.getElementById('perfil-nome').textContent = usuario.nome || '';
            document.getElementById('perfil-email').textContent = usuario.email || '';
            // Foto de perfil
            const img = document.getElementById('perfil-img');
            if (usuario.fotoPerfil) {
                img.src = usuario.fotoPerfil;
            } else {
                img.src = "img/icon.png";
            }
            document.getElementById('perfil-modal-bg').style.display = 'block';
        }
        function hidePerfilModal(e) {
            if (e.target.id === 'perfil-modal-bg') {
                document.getElementById('perfil-modal-bg').style.display = 'none';
                removerInputNome();
            }
        }
        document.getElementById('perfil-btn').addEventListener('click', showPerfilModal);
        document.getElementById('perfil-modal-bg').addEventListener('click', hidePerfilModal);

        // Alterar foto de perfil
        document.getElementById('alterar-foto-btn').addEventListener('click', function () {
            document.getElementById('foto-input').click();
        });
        document.getElementById('foto-input').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                const fotoBase64 = evt.target.result;
                // Atualiza a imagem do modal imediatamente
                document.getElementById('perfil-img').src = fotoBase64;
                atualizarUsuarioLogado({ fotoPerfil: fotoBase64 });
                // Atualiza a imagem do header tamb√©m
                atualizarFotoHeader();
            };
            reader.readAsDataURL(file);
        });

        // Alterar nome
        function removerInputNome() {
            const nomeSpan = document.getElementById('perfil-nome');
            if (nomeSpan.querySelector('input')) {
                const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
                nomeSpan.textContent = usuario.nome || '';
            }
        }
        document.getElementById('alterar-nome-btn').addEventListener('click', function () {
            const nomeSpan = document.getElementById('perfil-nome');
            if (nomeSpan.querySelector('input')) return; // j√° est√° editando
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = usuario.nome || '';
            input.style.fontSize = '15px';
            input.style.fontWeight = '600';
            input.style.borderRadius = '4px';
            input.style.padding = '2px 6px';
            input.style.width = '90%';
            input.maxLength = 32;
            
            // Aplica estilos baseados no tema atual
            applyThemeInputStyles(input);
            
            nomeSpan.textContent = '';
            nomeSpan.appendChild(input);
            input.focus();
            input.select();

            input.addEventListener('keydown', function (ev) {
                if (ev.key === 'Enter') {
                    ev.preventDefault();
                    salvarNome();
                } else if (ev.key === 'Escape') {
                    removerInputNome();
                }
            });
            input.addEventListener('blur', salvarNome);

            function salvarNome() {
                let novoNome = input.value.trim();
                if (!novoNome) novoNome = usuario.nome || '';
                atualizarUsuarioLogado({ nome: novoNome });
                nomeSpan.textContent = novoNome;
            }
        });

        // Abrir foto em tela cheia ao clicar na imagem do modal
        document.getElementById('perfil-img').addEventListener('click', function () {
            const src = this.src;
            const fullscreenBg = document.getElementById('foto-fullscreen-bg');
            const fullscreenImg = document.getElementById('foto-fullscreen-img');
            fullscreenImg.src = src;
            fullscreenImg.classList.remove('show'); // reset
            fullscreenBg.style.display = 'flex';
            // For√ßa reflow para reiniciar anima√ß√£o
            void fullscreenImg.offsetWidth;
            fullscreenImg.classList.add('show');
        });
        // Fechar ao clicar fora da imagem
        document.getElementById('foto-fullscreen-bg').addEventListener('click', function (e) {
            if (e.target === this) {
                this.style.display = 'none';
                document.getElementById('foto-fullscreen-img').src = '';
                document.getElementById('foto-fullscreen-img').classList.remove('show');
            }
        });

        // Sair da conta (mant√©m o perfil salvo no localStorage)
        document.getElementById('sair-btn').addEventListener('click', function () {
            AuthManager.logout();
        });

        // Exclus√£o de conta
        function showToast(title, message, type = 'error') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%); color: white; padding: 16px 50px 16px 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); z-index: 10000; display: flex; align-items: center; gap: 12px; min-width: 300px; max-width: 400px; opacity: 0; transform: translateX(400px); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);';
            if (type === 'success') toast.style.background = 'linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%)';
            const icons = { error: '‚ùå', success: '‚úÖ', info: '‚ÑπÔ∏è' };
            toast.innerHTML = `
                <div style="font-size: 24px; flex-shrink: 0;">${icons[type] || '‚ùå'}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">${title}</div>
                    <div style="font-size: 13px; opacity: 0.9;">${message}</div>
                </div>
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 8px; right: 8px; background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;">√ó</button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.style.cssText += 'opacity: 1; transform: translateX(0);', 100);
            setTimeout(() => {
                toast.style.cssText += 'opacity: 0; transform: translateX(400px);';
                setTimeout(() => toast.remove(), 400);
            }, 3500);
        }

        function openDeleteAccountModal() {
            document.getElementById('delete-account-modal-overlay').style.display = 'flex';
            document.getElementById('delete-account-password').value = '';
        }

        function closeDeleteAccountModal() {
            document.getElementById('delete-account-modal-overlay').style.display = 'none';
        }

        function confirmDeleteAccount() {
            const senha = document.getElementById('delete-account-password').value.trim();
            if (!senha) {
                showToast('Senha Necess√°ria', 'Digite sua senha para confirmar a exclus√£o.', 'error');
                return;
            }

            const usuario = AuthManager.getLoggedUser();
            if (!usuario) {
                showToast('Erro', 'Usu√°rio n√£o encontrado.', 'error');
                return;
            }

            // Verifica senha
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const userAccount = usuarios.find(u => u.email === usuario.email && u.senha === senha);

            if (!userAccount) {
                showToast('Senha Incorreta', 'A senha digitada est√° incorreta.', 'error');
                return;
            }

            // Remove dados do usu√°rio
            const userDataKey = `userData_${usuario.email}`;
            localStorage.removeItem(userDataKey);

            // Remove usu√°rio da lista
            const novosUsuarios = usuarios.filter(u => u.email !== usuario.email);
            localStorage.setItem('usuarios', JSON.stringify(novosUsuarios));

            // Remove sess√£o atual
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('chatHistory');
            localStorage.removeItem('treino');
            localStorage.removeItem('dieta');
            localStorage.removeItem('analiseHistorico');

            showToast('Conta Exclu√≠da', 'Sua conta foi exclu√≠da permanentemente.', 'success');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        document.getElementById('delete-account-btn').addEventListener('click', openDeleteAccountModal);
        
        document.getElementById('delete-account-modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'delete-account-modal-overlay') {
                closeDeleteAccountModal();
            }
        });

        // Modal Menu Lateral
        document.querySelector('.header-item.menu').addEventListener('click', function () {
            document.getElementById('menu-modal-bg').style.display = 'block';
        });
        document.getElementById('menu-modal-bg').addEventListener('click', function (e) {
            if (e.target.id === 'menu-modal-bg') {
                this.style.display = 'none';
            }
        });
    </script>

</body>

</html>
