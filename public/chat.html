<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trainew IA</title>
    <link rel="icon" href="img/favicon.png" type="image/png">
    <link rel="stylesheet" href="../css/chat.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/inicio.css">
    <link rel="stylesheet" href="../css/dark-theme.css">
    <link rel="stylesheet" href="../css/accessibility.css">
    <script src="../js/theme-manager.js"></script>
    <script src="../js/font-manager.js"></script>
    <script src="../js/chat-ai-handler.js"></script>

    <style>
        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #7A1919 0%, #5a1313 100%);
            color: white;
            padding: 16px 50px 16px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        body.dark-mode .toast-notification {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
            color: #1a1a1a;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 13px;
            opacity: 0.9;
        }

        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        body.dark-mode .toast-close {
            color: #1a1a1a;
        }

        .toast-close:hover {
            background: rgba(255,255,255,0.2);
        }

        body.dark-mode .toast-close:hover {
            background: rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .toast-notification {
                right: 10px;
                left: 10px;
                min-width: auto;
                max-width: none;
            }
        }

        /* Modal de Confirma√ß√£o */
        .confirm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        .confirm-modal-overlay.show {
            display: flex;
        }
        .confirm-modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        body.dark-mode .confirm-modal {
            background: #2a2a2a;
            color: #e8e8e8;
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .confirm-modal-icon {
            font-size: 48px;
            text-align: center;
            margin-bottom: 20px;
        }
        .confirm-modal-title {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }
        body.dark-mode .confirm-modal-title {
            color: #e8e8e8;
        }
        .confirm-modal-message {
            font-size: 16px;
            text-align: center;
            margin-bottom: 25px;
            color: #666;
            line-height: 1.5;
        }
        body.dark-mode .confirm-modal-message {
            color: #aaa;
        }
        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .confirm-modal-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .confirm-modal-btn.cancel {
            background: #e0e0e0;
            color: #333;
        }
        body.dark-mode .confirm-modal-btn.cancel {
            background: #444;
            color: #e8e8e8;
        }
        .confirm-modal-btn.cancel:hover {
            background: #d0d0d0;
        }
        body.dark-mode .confirm-modal-btn.cancel:hover {
            background: #555;
        }
        .confirm-modal-btn.confirm {
            background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
            color: white;
        }
        body.dark-mode .confirm-modal-btn.confirm {
            background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
        }
        .confirm-modal-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(198, 40, 40, 0.4);
        }

        /* Estilos para informa√ß√µes de exerc√≠cios */
        .chat-exercise-help {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
        }

        body.dark-mode .chat-exercise-help {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            border-left-color: #64b5f6;
        }

        .chat-exercise-help h4 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #1976d2;
        }

        body.dark-mode .chat-exercise-help h4 {
            color: #64b5f6;
        }

        .chat-exercise-help p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        .exercise-steps {
            margin: 12px 0 12px 20px;
            padding-left: 0;
            list-style: decimal;
        }

        .exercise-steps li {
            margin: 8px 0;
            padding-left: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }

        body.dark-mode .exercise-steps li {
            color: #e0e0e0;
        }

        .exercise-steps-compact {
            margin: 8px 0 8px 16px;
            padding-left: 0;
            list-style: decimal;
        }

        .exercise-steps-compact li {
            margin: 5px 0;
            padding-left: 5px;
            font-size: 13px;
            line-height: 1.5;
            color: #444;
        }

        body.dark-mode .exercise-steps-compact li {
            color: #d0d0d0;
        }

        .exercise-warning {
            background: rgba(255, 152, 0, 0.1);
            border-left: 3px solid #ff9800;
            padding: 8px 12px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        body.dark-mode .exercise-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left-color: #ffa726;
        }

        .chat-exercise-info {
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        body.dark-mode .chat-exercise-info {
            background: rgba(100, 181, 246, 0.15);
        }

        .chat-exercise-info p {
            margin: 6px 0;
            font-size: 13px;
        }

        .video-link {
            display: inline-block;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
        }

        .video-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 68, 68, 0.4);
        }

        body.dark-mode .video-link {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
        }

        .video-link-small {
            display: inline-block;
            color: #2196f3;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .video-link-small:hover {
            color: #1976d2;
            text-decoration: underline;
        }

        body.dark-mode .video-link-small {
            color: #64b5f6;
        }

        body.dark-mode .video-link-small:hover {
            color: #90caf9;
        }

        /* Estilos para informa√ß√µes de nutri√ß√£o */
        .chat-nutrition-info {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
            padding: 16px;
            border-radius: 12px;
            margin: 12px 0;
        }

        body.dark-mode .chat-nutrition-info {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            border-left-color: #81c784;
        }

        .chat-nutrition-info h4 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #388e3c;
        }

        body.dark-mode .chat-nutrition-info h4 {
            color: #81c784;
        }

        .chat-nutrition-info p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>

</head><body>
  <header class="header">
    <img onclick="window.location.href='inicio.html'" src="img/logo.png" alt="Logo Trainew IA" class="logo">
    <nav class="header-nav">
      <div class="header-item menu">
        <span class="menu-icon">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </span>
        <span class="item-label">Menu</span>
      </div>
      <div class="header-item perfil" id="perfil-btn">
        <img src="img/icon.png" class="perfil-icon" id="header-perfil-icon">
        <span class="item-label">Perfil</span>
      </div>
    </nav>
  </header>

  <!-- Modal Perfil -->
  <div class="perfil-modal-bg" id="perfil-modal-bg" style="display:none;">
    <div class="perfil-modal" id="perfil-modal">
      <div class="perfil-modal-header">Conta</div>
      <div class="perfil-modal-user">
        <span class="perfil-modal-user-icon" id="perfil-user-icon">
          <img src="img/icon.png" alt="Perfil" id="perfil-img" style="cursor:pointer;">
        </span>
        <div class="perfil-modal-user-info">
          <span class="perfil-modal-user-nome" id="perfil-nome"></span>
          <span class="perfil-modal-user-email" id="perfil-email"></span>
        </div>
      </div>
      <hr class="perfil-modal-divider">
      <div class="perfil-modal-list">
        <div class="perfil-modal-item" id="alterar-foto-btn">Alterar foto de perfil
          <input type="file" id="foto-input" accept="image/*" style="display:none;">
        </div>
        <div class="perfil-modal-item" id="alterar-nome-btn">Alterar nome</div>
        <div class="perfil-modal-item" onclick="window.location.href='config.html'">Configura√ß√µes</div>
        <div class="perfil-modal-item" onclick="window.location.href='ajuda.html'">Ajuda</div>
        <div class="perfil-modal-item" id="sair-btn" style="color:#c00;font-weight:600;">Sair</div>
      </div>
    </div>
  </div>

  <!-- Overlay para foto em tela cheia -->
  <div id="foto-fullscreen-bg"
    style="display:none;position:fixed;z-index:2000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;">
    <img id="foto-fullscreen-img" src="" alt="Foto perfil"
      style="max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 4px 32px #000;">
  </div>

  <!-- Modal Menu -->
  <div class="menu-modal-bg" id="menu-modal-bg" style="display:none;">
    <div class="menu-modal" id="menu-modal">
      <div class="menu-modal-header"><span>Menu</span></div>
      <hr class="menu-modal-divider">
      <div class="menu-modal-list">
        <div onclick="window.location.href='treino.html'" class="menu-modal-item">Treinos</div>
        <div onclick="window.location.href='dieta.html'" class="menu-modal-item">Dieta</div>
        <div onclick="window.location.href='alimentacao.html'" class="menu-modal-item">Alimenta√ß√£o</div>
        <div onclick="window.location.href='avaliacao.html'" class="menu-modal-item">Execu√ß√£o</div>
        <div onclick="window.location.href='sobre.html'" class="menu-modal-item">Sobre n√≥s</div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o -->
  <div class="confirm-modal-overlay" id="confirm-modal-overlay">
    <div class="confirm-modal">
      <div class="confirm-modal-icon">üóëÔ∏è</div>
      <h3 class="confirm-modal-title">Limpar Conversa?</h3>
      <p class="confirm-modal-message">Tem certeza que deseja apagar toda a conversa? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div class="confirm-modal-buttons">
        <button class="confirm-modal-btn cancel" onclick="closeConfirmModal()">Cancelar</button>
        <button class="confirm-modal-btn confirm" onclick="confirmClearChat()">Sim, Limpar</button>
      </div>
    </div>
  </div>


<button id="limpar-chat" class="chat-clear-btn">Limpar chat</button>

  <!-- √Årea principal do chat -->
  <div class="chat-container">
    <div class="chat-hint">Pergunte sobre treinos, alimenta√ß√£o ou pe√ßa um plano personalizado.</div>
    <div class="chat-messages" id="chat-messages"></div>
    <form class="chat-input-area" id="chat-form" autocomplete="off">
      <input type="text" id="chat-input" class="chat-input" placeholder="Digite sua mensagem..." autocomplete="off"
        required>
      <button type="submit" class="chat-send-btn" title="Enviar">&#10148;</button>
    </form>
  </div>

  <script>
// Verificar se o usu√°rio est√° logado
AuthManager.requireAuth();

// Fun√ß√£o para abrir modal de confirma√ß√£o
function openConfirmModal() {
  document.getElementById('confirm-modal-overlay').classList.add('show');
}

// Fun√ß√£o para fechar modal de confirma√ß√£o
function closeConfirmModal() {
  document.getElementById('confirm-modal-overlay').classList.remove('show');
}

// Fun√ß√£o para confirmar limpeza do chat
function confirmClearChat() {
  localStorage.removeItem('chatHistory');
  document.getElementById('chat-messages').innerHTML = '';
  chatHistory = [];
  closeConfirmModal();
  
  // Sincroniza dados vazios com o usu√°rio
  const user = AuthManager.getLoggedUser();
  if (user) {
    AuthManager.syncCurrentSessionData(user.email);
  }
  
  showToast('Chat Limpo', 'Conversa apagada com sucesso.', 'success');
}

// Event listener para bot√£o limpar chat
document.getElementById('limpar-chat').addEventListener('click', () => {
  openConfirmModal();
});

// Fechar modal ao clicar fora
document.getElementById('confirm-modal-overlay').addEventListener('click', (e) => {
  if (e.target.id === 'confirm-modal-overlay') {
    closeConfirmModal();
  }
});

  function scrollToBottom() {
    const chat = document.getElementById('chat-messages');
    chat.scrollTop = chat.scrollHeight;
  }

  function renderMessage({ text, sender, loading }) {
    const chat = document.getElementById('chat-messages');
    const row = document.createElement('div');
    row.className = 'msg-row ' + (sender === 'user' ? 'user' : 'ia');

    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.innerHTML = text; // permite link colorido
    if (loading) bubble.style.opacity = 0.6;

    row.appendChild(bubble);
    chat.appendChild(row);
    scrollToBottom();
    return bubble;
  }

  // Fun√ß√£o para animar texto letra por letra
  async function typeWriter(element, text, speed = 15) {
    element.innerHTML = '';
    let i = 0;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;
    const plainText = tempDiv.textContent || tempDiv.innerText;
    
    return new Promise((resolve) => {
      function type() {
        if (i < plainText.length) {
          // Para HTML, precisamos adicionar caractere por caractere
          const char = plainText.charAt(i);
          element.textContent += char;
          i++;
          scrollToBottom();
          setTimeout(type, speed);
        } else {
          // Ap√≥s terminar, aplicar HTML completo (para links e formata√ß√£o)
          element.innerHTML = text;
          resolve();
        }
      }
      type();
    });
  }

  // Hist√≥rico salvo entre sess√µes
  let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
  chatHistory.forEach(msg => renderMessage({ text: msg.text, sender: msg.sender }));

  function salvarHistorico() {
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    
    // Sincroniza automaticamente com os dados do usu√°rio
    const user = AuthManager.getLoggedUser();
    if (user) {
      AuthManager.syncCurrentSessionData(user.email);
    }
  }

  function salvarTabela(tipo, dados) {
    if (!tipo || !dados) return;
    console.log('üíæ Salvando', tipo, 'com', dados.length, 'itens');
    localStorage.setItem(tipo, JSON.stringify(dados));
    
    // Sincroniza automaticamente com os dados do usu√°rio
    const user = AuthManager.getLoggedUser();
    if (user) {
      AuthManager.syncCurrentSessionData(user.email);
    }
    
    // Mostrar notifica√ß√£o
    if (tipo === 'treino') {
      showToast('üí™ Treino Montado!', 'Acesse a aba Treinos para visualizar', 'treino');
    } else if (tipo === 'dieta') {
      showToast('ü•ó Dieta Montada!', 'Acesse a aba Dieta para visualizar', 'dieta');
    }
  }

  // Fun√ß√£o para mostrar toast notification
  function showToast(title, message, type) {
    // Remove toast anterior se existir
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
      existingToast.remove();
    }

    // Cria o toast
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    
    const icon = type === 'treino' ? 'üí™' : 'ü•ó';
    
    toast.innerHTML = `
      <div class="toast-icon">${icon}</div>
      <div class="toast-content">
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    document.body.appendChild(toast);
    
    // Anima entrada
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Remove automaticamente ap√≥s 3 segundos
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 400);
    }, 3000);
  }

  // Inicializa o gerenciador de tema
ThemeManager.init();

document.getElementById('chat-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';

    renderMessage({ text: msg, sender: 'user' });
    chatHistory.push({ text: msg, sender: 'user' });
    salvarHistorico();

    const loadingBubble = renderMessage({ text: '...', sender: 'ia', loading: true });

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg, history: chatHistory })
      });
      console.log("Requisi√ß√£o enviada para o servidor com a mensagem:", msg);

      const data = await response.json();
      let resposta = data.reply || '[Sem resposta]';

      // --- Verifica se h√° JSON dentro da resposta ---
      try {
        // Remove marcadores de c√≥digo markdown se existirem
        resposta = resposta.replace(/```json\s*/g, '').replace(/```\s*/g, '');
        
        // Encontra um trecho que pare√ßa JSON dentro da resposta
        const jsonMatch = resposta.match(/{[\s\S]*}/);
        if (jsonMatch) {
          const jsonStr = jsonMatch[0];
          const possibleJSON = JSON.parse(jsonStr);

          console.log("JSON extra√≠do da IA:", possibleJSON);

          if (possibleJSON.type && possibleJSON.data) {
            // Salvar com tipo correto
            const tipoSalvar = possibleJSON.type.toLowerCase().trim();
            console.log('üìã Tipo detectado:', tipoSalvar);
            salvarTabela(tipoSalvar, possibleJSON.data);
            
            // Remove o JSON da resposta e substitui pela mensagem bonita
            if (tipoSalvar === 'treino') {
              resposta = resposta.replace(jsonMatch[0], '').trim();
              if (!resposta || resposta.length < 10) {
                resposta = 'üí™ Treino pronto! Veja tudo na aba <span class="link-azul" onclick="window.location.href=\'treino.html\'">Treinos</span>. Deseja que eu monte uma dieta tamb√©m?';
              } else {
                resposta = resposta.replace(/üí™.*?Treinos[*"]?/g, 'üí™ Treino pronto! Veja tudo na aba <span class="link-azul" onclick="window.location.href=\'treino.html\'">Treinos</span>');
              }
            } else if (tipoSalvar === 'dieta') {
              resposta = resposta.replace(jsonMatch[0], '').trim();
              if (!resposta || resposta.length < 10) {
                resposta = 'ü•ó Dieta pronta! Veja tudo na aba <span class="link-azul" onclick="window.location.href=\'dieta.html\'">Dieta</span>. Quer que eu monte um plano de treino tamb√©m?';
              } else {
                resposta = resposta.replace(/ü•ó.*?Dieta[*"]?/g, 'ü•ó Dieta pronta! Veja tudo na aba <span class="link-azul" onclick="window.location.href=\'dieta.html\'">Dieta</span>');
              }
            }
          }
        }
        
        // Processa links para Treinos e Dieta que podem vir em qualquer resposta
        resposta = resposta.replace(/\*Treinos\*/g, '<span class="link-azul" onclick="window.location.href=\'treino.html\'">Treinos</span>');
        resposta = resposta.replace(/\*Dieta\*/g, '<span class="link-azul" onclick="window.location.href=\'dieta.html\'">Dieta</span>');
        
      } catch (err) {
        console.warn("Erro ao interpretar JSON da IA:", err);
        // Mesmo com erro, processa os links
        resposta = resposta.replace(/\*Treinos\*/g, '<span class="link-azul" onclick="window.location.href=\'treino.html\'">Treinos</span>');
        resposta = resposta.replace(/\*Dieta\*/g, '<span class="link-azul" onclick="window.location.href=\'dieta.html\'">Dieta</span>');
      }

      // Aguarda 500ms antes de come√ßar a digitar
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Processa a resposta com o ChatAIHandler para adicionar funcionalidades
      if (typeof ChatAIHandler !== 'undefined') {
        resposta = await ChatAIHandler.processMessage(msg, resposta);
      }
      
      // Anima a digita√ß√£o
      loadingBubble.style.opacity = 1;
      await typeWriter(loadingBubble, resposta, 15);
      
      chatHistory.push({ text: resposta, sender: 'ia' });
      salvarHistorico();
      scrollToBottom();
    } catch (err) {
      loadingBubble.textContent = 'Erro ao obter resposta. Tente novamente.';
      loadingBubble.style.opacity = 1;
    }
  });


</script>


<script>
// Modal Perfil
        function showPerfilModal() {
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
            document.getElementById('perfil-nome').textContent = usuario.nome || '';
            document.getElementById('perfil-email').textContent = usuario.email || '';
            // Foto de perfil
            const img = document.getElementById('perfil-img');
            if (usuario.fotoPerfil) {
                img.src = usuario.fotoPerfil;
            } else {
                img.src = "img/icon.png";
            }
            document.getElementById('perfil-modal-bg').style.display = 'block';
        }
        function hidePerfilModal(e) {
            if (e.target.id === 'perfil-modal-bg') {
                document.getElementById('perfil-modal-bg').style.display = 'none';
                removerInputNome();
            }
        }
        document.getElementById('perfil-btn').addEventListener('click', showPerfilModal);
        document.getElementById('perfil-modal-bg').addEventListener('click', hidePerfilModal);

        // Alterar foto de perfil
        document.getElementById('alterar-foto-btn').addEventListener('click', function () {
            document.getElementById('foto-input').click();
        });
        document.getElementById('foto-input').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                const fotoBase64 = evt.target.result;
                // Atualiza a imagem do modal imediatamente
                document.getElementById('perfil-img').src = fotoBase64;
                atualizarUsuarioLogado({ fotoPerfil: fotoBase64 });
                // Atualiza a imagem do header tamb√©m
                atualizarFotoHeader();
            };
            reader.readAsDataURL(file);
        });

        // Alterar nome
        function removerInputNome() {
            const nomeSpan = document.getElementById('perfil-nome');
            if (nomeSpan.querySelector('input')) {
                const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
                nomeSpan.textContent = usuario.nome || '';
            }
        }
        document.getElementById('alterar-nome-btn').addEventListener('click', function () {
            const nomeSpan = document.getElementById('perfil-nome');
            if (nomeSpan.querySelector('input')) return; // j√° est√° editando
            const usuario = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = usuario.nome || '';
            input.style.fontSize = '15px';
            input.style.fontWeight = '600';
            input.style.borderRadius = '4px';
            input.style.padding = '2px 6px';
            input.style.width = '90%';
            input.maxLength = 32;
            
            // Aplica estilos baseados no tema atual
            applyThemeInputStyles(input);
            
            nomeSpan.textContent = '';
            nomeSpan.appendChild(input);
            input.focus();
            input.select();

            input.addEventListener('keydown', function (ev) {
                if (ev.key === 'Enter') {
                    ev.preventDefault();
                    salvarNome();
                } else if (ev.key === 'Escape') {
                    removerInputNome();
                }
            });
            input.addEventListener('blur', salvarNome);

            function salvarNome() {
                let novoNome = input.value.trim();
                if (!novoNome) novoNome = usuario.nome || '';
                atualizarUsuarioLogado({ nome: novoNome });
                nomeSpan.textContent = novoNome;
            }
        });

        // Abrir foto em tela cheia ao clicar na imagem do modal
        document.getElementById('perfil-img').addEventListener('click', function () {
            const src = this.src;
            const fullscreenBg = document.getElementById('foto-fullscreen-bg');
            const fullscreenImg = document.getElementById('foto-fullscreen-img');
            fullscreenImg.src = src;
            fullscreenImg.classList.remove('show'); // reset
            fullscreenBg.style.display = 'flex';
            // For√ßa reflow para reiniciar anima√ß√£o
            void fullscreenImg.offsetWidth;
            fullscreenImg.classList.add('show');
        });
        // Fechar ao clicar fora da imagem
        document.getElementById('foto-fullscreen-bg').addEventListener('click', function (e) {
            if (e.target === this) {
                this.style.display = 'none';
                document.getElementById('foto-fullscreen-img').src = '';
                document.getElementById('foto-fullscreen-img').classList.remove('show');
            }
        });

        // Sair da conta (mant√©m o perfil salvo no localStorage)
        document.getElementById('sair-btn').addEventListener('click', function () {
            localStorage.removeItem('usuarioLogado');
            window.location.href = "index.html";
        });

        // Modal Menu Lateral
        document.querySelector('.header-item.menu').addEventListener('click', function () {
            document.getElementById('menu-modal-bg').style.display = 'block';
        });
        document.getElementById('menu-modal-bg').addEventListener('click', function (e) {
            if (e.target.id === 'menu-modal-bg') {
                this.style.display = 'none';
            }
        });
    </script>

</body>

</html>